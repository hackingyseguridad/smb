#!/bin/sh
# Detecta versión SMB y muestra vulnerabilidades conocidas
# @antonio_taboada

if command -v nmap &> /dev/null; then
    nmap -Pn -p 139,445 -sV --script smb-protocols,smb-vuln-ms17-010 $1 $2
else
    # Método manual con netcat
    echo -e "\x00\x00\x00\x85\xff\x53\x4d\x42\x72\x00\x00\x00\x00\x18\x01\x28" > /tmp/smb_probe.bin
    echo -e "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" >> /tmp/smb_probe.bin
    echo -e "\x00\x00\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" >> /tmp/smb_probe.bin
    echo -e "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" >> /tmp/smb_probe.bin
    echo -e "\x00\x00\x00\x00\x1c\x00\x00\x00\x00\x00\x02\x00\x02\x50\x43\x20" >> /tmp/smb_probe.bin
    echo -e "\x4e\x45\x54\x57\x4f\x52\x4b\x20\x50\x52\x4f\x47\x52\x41\x4d\x20" >> /tmp/smb_probe.bin
    echo -e "\x31\x2e\x30\x00\x02\x4c\x41\x4e\x4d\x41\x4e\x31\x2e\x30\x00\x00" >> /tmp/smb_probe.bin
    
    timeout 3 nc $target 445 < /tmp/smb_probe.bin | strings
fi

